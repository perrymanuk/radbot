<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RadBot Admin</title>
<style>
:root {
  --bg: #1a1a2e;
  --surface: #16213e;
  --surface2: #0f3460;
  --surface3: #1a2744;
  --accent: #e94560;
  --accent-dim: #b83350;
  --text: #eee;
  --text-muted: #999;
  --text-dim: #666;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #c0392b;
  --border: #2a3a5c;
  --sidebar-w: 240px;
  --header-h: 50px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

/* Auth overlay */
#auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
#auth-overlay .auth-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; width: 380px; }
#auth-overlay h2 { margin-bottom: 0.3rem; font-size: 1.3rem; }
#auth-overlay .sub { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
#auth-overlay input { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 0.9rem; margin-bottom: 1rem; }
#auth-overlay input:focus { outline: none; border-color: var(--accent); }

/* Header */
.header { height: var(--header-h); background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.2rem; }
.header h1 { font-size: 1.05rem; font-weight: 600; }
.header h1 span { color: var(--accent); }
.header .logout-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.header .logout-btn:hover { border-color: var(--accent); color: var(--text); }

/* Layout */
.app-layout { display: flex; height: calc(100vh - var(--header-h)); }

/* Sidebar */
.sidebar { width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 0.6rem 0; }
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.sidebar .group-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-dim); padding: 0.8rem 1rem 0.3rem; }
.sidebar .nav-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.45rem 1rem; cursor: pointer; font-size: 0.82rem; color: var(--text-muted); transition: all 0.15s; border-left: 3px solid transparent; }
.sidebar .nav-item:hover { background: var(--surface2); color: var(--text); }
.sidebar .nav-item.active { background: var(--surface2); color: var(--text); border-left-color: var(--accent); }
.sidebar .nav-item .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.sidebar .nav-item .dot.ok { background: var(--success); }
.sidebar .nav-item .dot.error { background: var(--danger); }
.sidebar .nav-item .dot.unconfigured { background: var(--text-dim); }
.sidebar .nav-item .dot.hidden { visibility: hidden; }

/* Content */
.content { flex: 1; overflow-y: auto; padding: 1.5rem 2rem; }
.content::-webkit-scrollbar { width: 6px; }
.content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Panel */
.panel { display: none; max-width: 800px; }
.panel.active { display: block; }
.panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
.panel-header h2 { font-size: 1.15rem; }
.panel-header .badge { font-size: 0.7rem; padding: 0.15rem 0.6rem; border-radius: 10px; font-weight: 600; }
.panel-header .badge.ok { background: #1b3a1b; color: var(--success); }
.panel-header .badge.error { background: #3a1b1b; color: var(--danger); }
.panel-header .badge.unconfigured { background: #2a2a2a; color: var(--text-dim); }

/* Form controls */
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; font-size: 0.78rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 500; }
.form-group .hint { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.15rem; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
input[type="text"], input[type="password"], input[type="number"], select, textarea {
  width: 100%; padding: 0.5rem 0.7rem; border: 1px solid var(--border); border-radius: 6px;
  background: var(--bg); color: var(--text); font-size: 0.85rem; font-family: inherit;
  transition: border-color 0.15s;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
textarea { resize: vertical; min-height: 80px; font-family: 'Consolas','Monaco','Fira Code',monospace; font-size: 0.8rem; }
textarea.large { min-height: 200px; }
select { cursor: pointer; }

/* Combobox (text + datalist) */
input[list] { cursor: text; }
input[list]::-webkit-calendar-picker-indicator { filter: invert(0.7); cursor: pointer; }

/* Toggle switch */
.toggle-wrap { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; }
.toggle-wrap label { margin-bottom: 0; font-size: 0.82rem; color: var(--text-muted); cursor: pointer; }
.toggle { position: relative; width: 38px; height: 20px; flex-shrink: 0; cursor: pointer; }
.toggle input { position: absolute; width: 100%; height: 100%; opacity: 0; z-index: 2; cursor: pointer; margin: 0; }
.toggle .slider { position: absolute; inset: 0; background: var(--border); border-radius: 10px; cursor: pointer; transition: 0.2s; z-index: 1; }
.toggle .slider::before { content: ''; position: absolute; width: 14px; height: 14px; left: 3px; bottom: 3px; background: var(--text-muted); border-radius: 50%; transition: 0.2s; }
.toggle input:checked + .slider { background: var(--accent); }
.toggle input:checked + .slider::before { transform: translateX(18px); background: #fff; }

/* Slider input */
.slider-wrap { display: flex; align-items: center; gap: 0.8rem; }
.slider-wrap input[type="range"] { flex: 1; accent-color: var(--accent); background: transparent; }
.slider-wrap .val { min-width: 3em; text-align: right; font-size: 0.82rem; color: var(--text-muted); font-family: monospace; }

/* Buttons */
.btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.82rem; font-weight: 500; transition: all 0.15s; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--accent-dim); }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover:not(:disabled) { border-color: var(--accent); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover:not(:disabled) { opacity: 0.85; }
.btn-sm { padding: 0.3rem 0.7rem; font-size: 0.78rem; }
.btn-icon { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 28px; height: 28px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; }
.btn-icon:hover { border-color: var(--accent); color: var(--text); }

/* Action bar */
.action-bar { display: flex; gap: 0.6rem; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.action-bar .spacer { flex: 1; }
.action-bar .test-result { font-size: 0.82rem; }
.action-bar .test-result.ok { color: var(--success); }
.action-bar .test-result.error { color: var(--danger); }

/* Card / Section */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.2rem; margin-bottom: 1rem; }
.card h3 { font-size: 0.9rem; margin-bottom: 0.8rem; color: var(--accent); }

/* Collapsible */
.collapsible-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 0.6rem 0; }
.collapsible-header h3 { font-size: 0.88rem; color: var(--text-muted); }
.collapsible-header .arrow { transition: transform 0.2s; color: var(--text-dim); font-size: 0.7rem; }
.collapsible-header.open .arrow { transform: rotate(90deg); }
.collapsible-body { display: none; padding-top: 0.5rem; }
.collapsible-body.open { display: block; }

/* KV editor */
.kv-editor .kv-row { display: flex; gap: 0.5rem; margin-bottom: 0.4rem; align-items: center; }
.kv-editor .kv-row input { flex: 1; }
.kv-editor .kv-row .btn-icon { flex-shrink: 0; }

/* Dynamic list (MCP servers, Gmail accounts) */
.dynamic-card { background: var(--surface3); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.8rem; overflow: hidden; }
.dynamic-card .dc-header { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 1rem; cursor: pointer; background: var(--surface2); }
.dynamic-card .dc-header h4 { font-size: 0.85rem; font-weight: 500; }
.dynamic-card .dc-header .dc-meta { font-size: 0.75rem; color: var(--text-dim); }
.dynamic-card .dc-body { padding: 1rem; display: none; }
.dynamic-card .dc-body.open { display: block; }

/* Table */
table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
th, td { text-align: left; padding: 0.5rem 0.6rem; border-bottom: 1px solid var(--border); }
th { color: var(--text-muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }

/* Toast */
.toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.7rem 1.2rem; border-radius: 8px; color: #fff; display: none; z-index: 2000; font-size: 0.82rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 400px; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }

/* Store banner */
.store-banner { background: #3e2723; color: #ffab91; padding: 0.6rem 1.2rem; font-size: 0.8rem; border-bottom: 1px solid #5d4037; }
.store-banner code { background: rgba(0,0,0,0.2); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.75rem; }

/* Pre block */
pre { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.8rem; overflow-x: auto; font-size: 0.78rem; max-height: 500px; overflow-y: auto; }

/* Note box */
.note { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 0.7rem 1rem; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }

/* Conditional visibility */
.conditional { display: none; }
.conditional.visible { display: block; }

/* Spinner */
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Empty state */
.empty { color: var(--text-dim); font-size: 0.85rem; padding: 1rem 0; }
</style>
</head>
<body>

<!-- Auth Overlay -->
<div id="auth-overlay">
  <div class="auth-box">
    <h2>RadBot Admin</h2>
    <p class="sub">Enter your admin token to continue</p>
    <input type="password" id="auth-token" placeholder="RADBOT_ADMIN_TOKEN" autofocus>
    <button class="btn btn-primary" style="width:100%" onclick="App.auth()">Authenticate</button>
  </div>
</div>

<!-- Header -->
<div class="header" id="app-header" style="display:none">
  <h1><span>Rad</span>Bot Admin</h1>
  <button class="logout-btn" onclick="App.logout()">Logout</button>
</div>

<!-- Credential store warning banner -->
<div class="store-banner" id="store-banner" style="display:none">
  <strong>Credential store unavailable</strong> — Set the <code>RADBOT_CREDENTIAL_KEY</code> environment variable to enable saving configuration and credentials. Current values from <code>config.yaml</code> are shown read-only.
</div>

<!-- Main layout -->
<div class="app-layout" id="app-layout" style="display:none">
  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar"></nav>

  <!-- Content -->
  <main class="content" id="content"></main>
</div>

<div class="toast" id="toast"></div>

<!-- Datalists for comboboxes -->
<datalist id="dl-models">
  <option value="gemini-3-pro-preview">
  <option value="gemini-2.5-pro">
  <option value="gemini-2.5-flash">
  <option value="gemini-2.0-flash">
  <option value="gemini-2.0-flash-lite">
  <option value="gemini-1.5-pro">
  <option value="gemini-1.5-flash">
</datalist>
<datalist id="dl-timezones">
  <option value="America/New_York">
  <option value="America/Chicago">
  <option value="America/Denver">
  <option value="America/Los_Angeles">
  <option value="America/Anchorage">
  <option value="Pacific/Honolulu">
  <option value="Europe/London">
  <option value="Europe/Berlin">
  <option value="Europe/Paris">
  <option value="Asia/Tokyo">
  <option value="Asia/Shanghai">
  <option value="Australia/Sydney">
  <option value="UTC">
</datalist>
<datalist id="dl-voices">
  <option value="en-US-Casual-K">
  <option value="en-US-Journey-D">
  <option value="en-US-Journey-F">
  <option value="en-US-Neural2-A">
  <option value="en-US-Neural2-C">
  <option value="en-US-Neural2-D">
  <option value="en-US-Neural2-F">
  <option value="en-US-Standard-A">
  <option value="en-US-Standard-B">
  <option value="en-US-Wavenet-A">
  <option value="en-US-Wavenet-D">
</datalist>

<script>
(function() {
"use strict";

// =====================================================================
// Utilities
// =====================================================================
let _token = '';
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };

function toast(msg, type) {
  const el = $('#toast');
  el.textContent = msg;
  el.className = 'toast ' + type;
  el.style.display = 'block';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.style.display = 'none', 4000);
}

async function api(path, opts = {}) {
  const h = { 'Authorization': `Bearer ${_token}`, 'Content-Type': 'application/json', ...opts.headers };
  const res = await fetch(path, { ...opts, headers: h });
  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    throw new Error(`HTTP ${res.status}: ${txt.slice(0, 200)}`);
  }
  return res.json();
}

// =====================================================================
// Auth
// =====================================================================
const Auth = {
  check() {
    _token = sessionStorage.getItem('admin_token') || '';
    if (_token) { this.show(); return; }
    $('#auth-overlay').style.display = 'flex';
  },
  async login(token) {
    _token = token;
    try {
      await api('/admin/api/credentials');
      sessionStorage.setItem('admin_token', token);
      this.show();
    } catch(e) {
      _token = '';
      toast('Invalid token', 'error');
    }
  },
  show() {
    $('#auth-overlay').style.display = 'none';
    $('#app-header').style.display = 'flex';
    $('#app-layout').style.display = 'flex';
    Sidebar.render();
    Router.init();
    StatusPoller.poll();
  },
  logout() {
    _token = '';
    sessionStorage.removeItem('admin_token');
    location.reload();
  }
};

// =====================================================================
// Sidebar definition
// =====================================================================
const NAV = [
  { group: 'Core', items: [
    { id: 'google', label: 'Google API', dot: 'google' },
    { id: 'agent-models', label: 'Agent Models' },
    { id: 'web-server', label: 'Web Server' },
    { id: 'logging', label: 'Logging' },
  ]},
  { group: 'Connections', items: [
    { id: 'gmail', label: 'Gmail', dot: 'gmail' },
    { id: 'calendar', label: 'Calendar', dot: 'calendar' },
    { id: 'jira', label: 'Jira', dot: 'jira' },
    { id: 'home-assistant', label: 'Home Assistant', dot: 'home_assistant' },
    { id: 'tavily', label: 'Web Search', dot: 'tavily' },
    { id: 'mcp-servers', label: 'MCP Servers' },
    { id: 'crawl4ai', label: 'Crawl4AI', dot: 'crawl4ai' },
    { id: 'filesystem', label: 'Filesystem' },
  ]},
  { group: 'Infrastructure', items: [
    { id: 'postgresql', label: 'PostgreSQL', dot: 'postgresql' },
    { id: 'qdrant', label: 'Qdrant', dot: 'qdrant' },
    { id: 'redis', label: 'Redis Cache', dot: 'redis' },
  ]},
  { group: 'Media / Voice', items: [
    { id: 'tts', label: 'TTS' },
    { id: 'stt', label: 'STT' },
  ]},
  { group: 'Automation', items: [
    { id: 'scheduler', label: 'Scheduler' },
    { id: 'webhooks', label: 'Webhooks' },
  ]},
  { group: 'Advanced', items: [
    { id: 'credentials', label: 'Credentials' },
    { id: 'raw-config', label: 'Raw Config' },
  ]},
];

const Sidebar = {
  render() {
    let html = '';
    for (const g of NAV) {
      html += `<div class="group-label">${esc(g.group)}</div>`;
      for (const item of g.items) {
        const dotClass = item.dot ? 'dot unconfigured' : 'dot hidden';
        html += `<div class="nav-item" data-panel="${item.id}" onclick="Router.go('${item.id}')">
          <span class="${dotClass}" data-dot="${item.dot || ''}"></span>
          <span>${esc(item.label)}</span>
        </div>`;
      }
    }
    $('#sidebar').innerHTML = html;
  },
  setDot(key, status) {
    const dot = $(`.nav-item .dot[data-dot="${key}"]`);
    if (dot) {
      dot.className = 'dot ' + (status || 'unconfigured');
    }
  }
};

// =====================================================================
// Router
// =====================================================================
const Router = {
  current: null,
  init() {
    const hash = location.hash.slice(1) || 'google';
    this.go(hash);
  },
  go(id) {
    if (this.current === id) return;
    this.current = id;
    location.hash = id;
    $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.panel === id));
    $$('.panel').forEach(p => p.classList.remove('active'));
    let panel = $(`#panel-${id}`);
    if (!panel) {
      Panels.build(id);
      panel = $(`#panel-${id}`);
    }
    if (panel) {
      panel.classList.add('active');
      Panels.load(id);
    }
  }
};

// =====================================================================
// FormBuilder — reusable field generators
// =====================================================================
const FB = {
  text(name, label, opts = {}) {
    const ph = opts.placeholder || '';
    const hint = opts.hint ? `<div class="hint">${esc(opts.hint)}</div>` : '';
    const ro = opts.readonly ? 'readonly' : '';
    const ds = opts.storage || 'config';
    const dl = opts.datalist ? `list="${opts.datalist}"` : '';
    return `<div class="form-group ${opts.conditional ? 'conditional' : ''}" ${opts.conditional ? `data-cond="${opts.conditional}"` : ''}>
      <label>${esc(label)}</label>
      <input type="text" name="${name}" data-storage="${ds}" placeholder="${esc(ph)}" ${ro} ${dl}>
      ${hint}
    </div>`;
  },
  password(name, label, opts = {}) {
    const ds = opts.storage || 'credential';
    const ph = opts.placeholder || '';
    return `<div class="form-group ${opts.conditional ? 'conditional' : ''}" ${opts.conditional ? `data-cond="${opts.conditional}"` : ''}>
      <label>${esc(label)}</label>
      <input type="password" name="${name}" data-storage="${ds}" placeholder="${esc(ph)}">
    </div>`;
  },
  number(name, label, opts = {}) {
    const ds = opts.storage || 'config';
    const min = opts.min !== undefined ? `min="${opts.min}"` : '';
    const max = opts.max !== undefined ? `max="${opts.max}"` : '';
    const step = opts.step !== undefined ? `step="${opts.step}"` : '';
    return `<div class="form-group">
      <label>${esc(label)}</label>
      <input type="number" name="${name}" data-storage="${ds}" ${min} ${max} ${step}>
    </div>`;
  },
  toggle(name, label, opts = {}) {
    const ds = opts.storage || 'config';
    return `<div class="toggle-wrap">
      <div class="toggle"><input type="checkbox" name="${name}" data-storage="${ds}"><span class="slider"></span></div>
      <label onclick="this.previousElementSibling.querySelector('input').click()">${esc(label)}</label>
    </div>`;
  },
  dropdown(name, label, options, opts = {}) {
    const ds = opts.storage || 'config';
    let optHtml = options.map(o => {
      const val = typeof o === 'string' ? o : o.value;
      const lbl = typeof o === 'string' ? o : o.label;
      return `<option value="${esc(val)}">${esc(lbl)}</option>`;
    }).join('');
    return `<div class="form-group ${opts.conditional ? 'conditional' : ''}" ${opts.conditional ? `data-cond="${opts.conditional}"` : ''}>
      <label>${esc(label)}</label>
      <select name="${name}" data-storage="${ds}">${optHtml}</select>
    </div>`;
  },
  textarea(name, label, opts = {}) {
    const ds = opts.storage || 'credential';
    const cls = opts.large ? 'large' : '';
    return `<div class="form-group">
      <label>${esc(label)}</label>
      <textarea name="${name}" data-storage="${ds}" class="${cls}" placeholder="${esc(opts.placeholder || '')}"></textarea>
    </div>`;
  },
  slider(name, label, min, max, step, opts = {}) {
    const ds = opts.storage || 'config';
    return `<div class="form-group">
      <label>${esc(label)}</label>
      <div class="slider-wrap">
        <input type="range" name="${name}" data-storage="${ds}" min="${min}" max="${max}" step="${step}"
          oninput="this.nextElementSibling.textContent=this.value">
        <span class="val">${min}</span>
      </div>
    </div>`;
  },
  note(text) {
    return `<div class="note">${text}</div>`;
  },
  collapsible(title, body) {
    return `<div>
      <div class="collapsible-header" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        <h3>${esc(title)}</h3><span class="arrow">&#9654;</span>
      </div>
      <div class="collapsible-body">${body}</div>
    </div>`;
  },
  actionBar(opts = {}) {
    let html = '<div class="action-bar">';
    if (opts.test) {
      html += `<button class="btn btn-secondary" onclick="${opts.test}">Test Connection</button>`;
      html += `<span class="test-result" id="test-${opts.panelId || ''}"></span>`;
    }
    html += '<span class="spacer"></span>';
    if (opts.save !== false) {
      html += `<button class="btn btn-primary" onclick="${opts.save || `SaveManager.save('${opts.panelId}')`}">Save</button>`;
    }
    html += '</div>';
    return html;
  }
};

// =====================================================================
// Panel definitions
// =====================================================================
const _panelBuilt = {};
const _liveConfig = {};

const Panels = {
  build(id) {
    if (_panelBuilt[id]) return;
    _panelBuilt[id] = true;
    const fn = this['build_' + id.replace(/-/g, '_')];
    if (fn) fn.call(this);
  },

  load(id) {
    const fn = this['load_' + id.replace(/-/g, '_')];
    if (fn) fn.call(this);
  },

  _mkPanel(id, title, body, dotKey) {
    const badge = dotKey ? `<span class="badge unconfigured" id="badge-${id}">--</span>` : '';
    const div = document.createElement('div');
    div.className = 'panel';
    div.id = `panel-${id}`;
    div.innerHTML = `<div class="panel-header"><h2>${esc(title)}</h2>${badge}</div>${body}`;
    $('#content').appendChild(div);
  },

  // ----------------------------------------------------------
  // CORE: Google API
  // ----------------------------------------------------------
  build_google() {
    this._mkPanel('google', 'Google API', `
      <div class="card" data-section="api_keys">
        ${FB.password('google_api_key', 'Google API Key', { placeholder: 'AIza...' })}
      </div>
      <div class="card" data-section="agent">
        ${FB.toggle('use_vertex_ai', 'Use Vertex AI')}
        <div class="conditional" data-cond="use_vertex_ai">
          ${FB.text('vertex_project', 'Vertex Project ID', { storage: 'config' })}
          ${FB.text('vertex_location', 'Vertex Location', { storage: 'config', placeholder: 'us-central1' })}
        </div>
        ${FB.textarea('google_service_account', 'Service Account JSON (optional)', { placeholder: '{"type":"service_account",...}' })}
      </div>
      ${FB.actionBar({ test: "Panels.testGoogle()", panelId: 'google', save: "SaveManager.saveGoogle()" })}
    `, 'google');
  },

  async load_google() {
    const cfg = await this._loadLive();
    this._setVal('google_api_key', '***');
    this._setChecked('use_vertex_ai', cfg.agent?.use_vertex_ai || false);
    this._setVal('vertex_project', cfg.agent?.vertex_project || '');
    this._setVal('vertex_location', cfg.agent?.vertex_location || '');
    this._updateConditionals();
    // Listen for toggle changes
    const toggle = $('input[name="use_vertex_ai"]');
    if (toggle) toggle.addEventListener('change', () => this._updateConditionals());
  },

  async testGoogle() {
    const el = $('#test-google');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const apiKey = this._getVal('google_api_key');
      const body = {};
      if (apiKey && apiKey !== '***') body.api_key = apiKey;
      const r = await api('/admin/api/test/google', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CORE: Agent Models
  // ----------------------------------------------------------
  build_agent_models() {
    const agentNames = [
      'search', 'scout', 'axel', 'george', 'memory', 'todo',
      'calendar', 'homeassistant', 'gmail', 'jira', 'code_execution',
      'web_research', 'filesystem'
    ];
    let overrides = '';
    for (const a of agentNames) {
      overrides += FB.text(`agent_models.${a}`, a, { datalist: 'dl-models', storage: 'config' });
    }

    this._mkPanel('agent-models', 'Agent Models', `
      <div class="card" data-section="agent">
        <div class="form-row">
          ${FB.text('main_model', 'Main Model', { datalist: 'dl-models', storage: 'config' })}
          ${FB.text('sub_agent_model', 'Sub-Agent Default Model', { datalist: 'dl-models', storage: 'config' })}
        </div>
        ${FB.toggle('enable_adk_search', 'Enable ADK Search')}
        ${FB.toggle('enable_adk_code_execution', 'Enable ADK Code Execution')}
        ${FB.collapsible('Per-Agent Model Overrides', `<div class="form-row">${overrides}</div>`)}
      </div>
      ${FB.actionBar({ panelId: 'agent-models', save: "SaveManager.saveSection('agent-models','agent')" })}
    `);
  },

  async load_agent_models() {
    const cfg = await this._loadLive();
    const a = cfg.agent || {};
    this._setVal('main_model', a.main_model || '');
    this._setVal('sub_agent_model', a.sub_agent_model || '');
    this._setChecked('enable_adk_search', a.enable_adk_search || false);
    this._setChecked('enable_adk_code_execution', a.enable_adk_code_execution || false);
    const models = a.agent_models || {};
    for (const [k, v] of Object.entries(models)) {
      this._setVal(`agent_models.${k}`, v || '');
    }
  },

  // ----------------------------------------------------------
  // CORE: Web Server
  // ----------------------------------------------------------
  build_web_server() {
    this._mkPanel('web-server', 'Web Server', `
      <div class="card" data-section="web">
        <div class="form-row">
          ${FB.text('host', 'Host', { storage: 'config', placeholder: '0.0.0.0' })}
          ${FB.number('port', 'Port', { storage: 'config', min: 1, max: 65535 })}
        </div>
        ${FB.toggle('debug', 'Debug Mode')}
      </div>
      ${FB.actionBar({ panelId: 'web-server', save: "SaveManager.saveSection('web-server','web')" })}
    `);
  },

  async load_web_server() {
    const cfg = await this._loadLive();
    const w = cfg.web || {};
    this._setVal('host', w.host || '0.0.0.0');
    this._setVal('port', w.port || 8080);
    this._setChecked('debug', w.debug || false);
  },

  // ----------------------------------------------------------
  // CORE: Logging
  // ----------------------------------------------------------
  build_logging() {
    this._mkPanel('logging', 'Logging', `
      <div class="card" data-section="logging">
        ${FB.dropdown('level', 'Level', ['DEBUG','INFO','WARNING','ERROR','CRITICAL'])}
        ${FB.text('format', 'Format', { storage: 'config', placeholder: '%(asctime)s - %(name)s - %(levelname)s - %(message)s' })}
        ${FB.text('file', 'Log File', { storage: 'config', placeholder: '/var/log/radbot/radbot.log' })}
      </div>
      ${FB.actionBar({ panelId: 'logging', save: "SaveManager.saveSection('logging','logging')" })}
    `);
  },

  async load_logging() {
    const cfg = await this._loadLive();
    const l = cfg.logging || {};
    this._setVal('level', l.level || 'INFO');
    this._setVal('format', l.format || '');
    this._setVal('file', l.file || '');
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Gmail
  // ----------------------------------------------------------
  build_gmail() {
    this._mkPanel('gmail', 'Gmail', `
      <div class="card" data-section="integrations">
        ${FB.toggle('gmail_enabled', 'Enabled')}
        ${FB.textarea('gmail_oauth_client', 'OAuth Client JSON', { placeholder: '{"installed":{...}}' })}
      </div>
      <div class="card">
        <h3>Accounts</h3>
        <div id="gmail-accounts"><span class="spinner"></span> Loading...</div>
        <div style="margin-top:0.8rem">
          <div class="form-row" style="max-width:400px">
            <div class="form-group"><label>Account Label</label><input type="text" id="gmail-new-label" placeholder="e.g. personal"></div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="Panels.gmailAddAccount()">Add Account (Begin OAuth)</button>
        </div>
      </div>
      ${FB.actionBar({ panelId: 'gmail', save: "SaveManager.saveGmail()" })}
    `, 'gmail');
  },

  async load_gmail() {
    const cfg = await this._loadLive();
    const g = cfg.integrations?.gmail || {};
    this._setChecked('gmail_enabled', g.enabled || false);
    // Load accounts
    try {
      const r = await api('/admin/api/gmail/accounts');
      const el = $('#gmail-accounts');
      if (!r.accounts || !r.accounts.length) {
        el.innerHTML = '<p class="empty">No Gmail accounts configured.</p>';
      } else {
        let html = '<table><thead><tr><th>Account</th><th>Email</th><th>Source</th><th></th><th></th></tr></thead><tbody>';
        for (const a of r.accounts) {
          html += `<tr>
            <td>${esc(a.account)}</td>
            <td>${esc(a.email)}</td>
            <td>${esc(a.source || 'file')}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="Panels.testGmailAccount('${esc(a.account)}',this)">Test</button></td>
            <td><button class="btn btn-danger btn-sm" onclick="Panels.removeGmailAccount('${esc(a.account)}')">Remove</button></td>
          </tr>`;
        }
        html += '</tbody></table>';
        el.innerHTML = html;
      }
    } catch(e) { $('#gmail-accounts').innerHTML = `<p class="empty">Error: ${esc(e.message)}</p>`; }
  },

  async testGmailAccount(account, btn) {
    const orig = btn.textContent;
    btn.innerHTML = '<span class="spinner"></span>';
    btn.disabled = true;
    try {
      const r = await api(`/admin/api/test/gmail/${encodeURIComponent(account)}`, { method: 'POST', body: '{}' });
      toast(r.message, r.status === 'ok' ? 'success' : 'error');
    } catch(e) { toast(e.message, 'error'); }
    btn.textContent = orig;
    btn.disabled = false;
  },

  async removeGmailAccount(account) {
    if (!confirm(`Remove Gmail account "${account}"? This deletes the stored token.`)) return;
    try {
      await api(`/admin/api/credentials/gmail_token_${encodeURIComponent(account)}`, { method: 'DELETE' });
      toast(`Account "${account}" removed`, 'success');
      this.load_gmail();
    } catch(e) { toast(e.message, 'error'); }
  },

  gmailAddAccount() {
    const label = $('#gmail-new-label').value.trim() || 'default';
    window.open(`/admin/api/credentials/gmail/setup?account=${encodeURIComponent(label)}&token=${encodeURIComponent(_token)}`, '_blank');
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Calendar
  // ----------------------------------------------------------
  build_calendar() {
    this._mkPanel('calendar', 'Google Calendar', `
      <div class="card" data-section="integrations">
        ${FB.toggle('calendar_enabled', 'Enabled')}
        ${FB.dropdown('calendar_auth_method', 'Auth Method', [
          { value: 'service_account', label: 'Service Account' },
          { value: 'oauth', label: 'OAuth' }
        ])}
        <div class="conditional" data-cond="calendar_auth_method:service_account">
          ${FB.textarea('calendar_service_account', 'Service Account JSON', { placeholder: '{"type":"service_account",...}' })}
        </div>
        <div class="conditional" data-cond="calendar_auth_method:oauth">
          <button class="btn btn-secondary btn-sm" onclick="window.open('/admin/api/credentials/calendar/setup?token='+encodeURIComponent(_token),'_blank')">Setup Calendar OAuth</button>
          <div style="height:0.8rem"></div>
        </div>
        ${FB.text('calendar_id', 'Calendar ID', { storage: 'config', placeholder: 'primary' })}
        ${FB.text('calendar_timezone', 'Timezone', { storage: 'config', datalist: 'dl-timezones' })}
        ${FB.text('calendar_impersonation_email', 'Impersonation Email', { storage: 'config', hint: 'Required for service account auth' })}
      </div>
      ${FB.actionBar({ test: "Panels.testCalendar()", panelId: 'calendar', save: "SaveManager.saveCalendar()" })}
    `, 'calendar');
  },

  async load_calendar() {
    const cfg = await this._loadLive();
    const c = cfg.integrations?.calendar || {};
    this._setChecked('calendar_enabled', c.enabled || false);
    this._setVal('calendar_auth_method', c.service_account_file ? 'service_account' : 'oauth');
    this._setVal('calendar_id', c.calendar_id || '');
    this._setVal('calendar_timezone', c.timezone || '');
    this._setVal('calendar_impersonation_email', c.impersonation_email || '');
    this._updateConditionals();
    const sel = $('select[name="calendar_auth_method"]');
    if (sel) sel.addEventListener('change', () => this._updateConditionals());
  },

  async testCalendar() {
    const el = $('#test-calendar');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const r = await api('/admin/api/test/calendar', { method: 'POST', body: '{}' });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Jira
  // ----------------------------------------------------------
  build_jira() {
    this._mkPanel('jira', 'Jira', `
      <div class="card" data-section="integrations">
        ${FB.toggle('jira_enabled', 'Enabled')}
        ${FB.text('jira_url', 'Jira URL', { storage: 'config', placeholder: 'https://your-org.atlassian.net' })}
        ${FB.text('jira_email', 'Email', { storage: 'config' })}
        ${FB.password('jira_api_token', 'API Token')}
      </div>
      ${FB.actionBar({ test: "Panels.testJira()", panelId: 'jira', save: "SaveManager.saveJira()" })}
    `, 'jira');
  },

  async load_jira() {
    const cfg = await this._loadLive();
    const j = cfg.integrations?.jira || {};
    this._setChecked('jira_enabled', j.enabled || false);
    this._setVal('jira_url', j.url || '');
    this._setVal('jira_email', j.email || '');
    this._setVal('jira_api_token', j.api_token ? '***' : '');
  },

  async testJira() {
    const el = $('#test-jira');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = {
        url: this._getVal('jira_url'),
        email: this._getVal('jira_email'),
        api_token: this._getVal('jira_api_token'),
      };
      const r = await api('/admin/api/test/jira', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Home Assistant
  // ----------------------------------------------------------
  build_home_assistant() {
    this._mkPanel('home-assistant', 'Home Assistant', `
      <div class="card" data-section="integrations">
        ${FB.toggle('ha_enabled', 'Enabled')}
        ${FB.text('ha_url', 'URL', { storage: 'config', placeholder: 'http://homeassistant.local:8123' })}
        ${FB.password('ha_token', 'Access Token')}
        ${FB.text('ha_mcp_sse_url', 'MCP SSE URL', { storage: 'config', placeholder: 'http://homeassistant.local:8123/mcp_server/sse', hint: 'URL for HA MCP server SSE endpoint' })}
      </div>
      ${FB.actionBar({ test: "Panels.testHA()", panelId: 'home-assistant', save: "SaveManager.saveHA()" })}
    `, 'home_assistant');
  },

  async load_home_assistant() {
    const cfg = await this._loadLive();
    const h = cfg.integrations?.home_assistant || {};
    this._setChecked('ha_enabled', h.enabled || false);
    this._setVal('ha_url', h.url || '');
    this._setVal('ha_token', h.token ? '***' : '');
    this._setVal('ha_mcp_sse_url', h.mcp_sse_url || '');
  },

  async testHA() {
    const el = $('#test-home-assistant');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = {
        url: this._getVal('ha_url'),
        token: this._getVal('ha_token'),
      };
      const r = await api('/admin/api/test/home-assistant', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Tavily (Web Search)
  // ----------------------------------------------------------
  build_tavily() {
    this._mkPanel('tavily', 'Web Search (Tavily)', `
      <div class="card">
        ${FB.password('tavily_api_key', 'Tavily API Key')}
      </div>
      ${FB.actionBar({ test: "Panels.testTavily()", panelId: 'tavily', save: "SaveManager.saveTavily()" })}
    `, 'tavily');
  },

  async load_tavily() {
    const cfg = await this._loadLive();
    const key = cfg.api_keys?.tavily;
    this._setVal('tavily_api_key', key ? '***' : '');
  },

  async testTavily() {
    const el = $('#test-tavily');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = { api_key: this._getVal('tavily_api_key') };
      const r = await api('/admin/api/test/tavily', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CONNECTIONS: MCP Servers
  // ----------------------------------------------------------
  build_mcp_servers() {
    this._mkPanel('mcp-servers', 'MCP Servers', `
      <div id="mcp-list"></div>
      <button class="btn btn-secondary" onclick="Panels.mcpAdd()" style="margin-top:0.6rem">+ Add Server</button>
      ${FB.actionBar({ panelId: 'mcp-servers', save: "SaveManager.saveMCP()" })}
    `);
  },

  _mcpServers: [],

  async load_mcp_servers() {
    const cfg = await this._loadLive();
    this._mcpServers = cfg.integrations?.mcp?.servers || [];
    this._renderMCPList();
  },

  _renderMCPList() {
    const el = $('#mcp-list');
    if (!this._mcpServers.length) {
      el.innerHTML = '<p class="empty">No MCP servers configured.</p>';
      return;
    }
    let html = '';
    this._mcpServers.forEach((s, i) => {
      const transport = s.transport || 'sse';
      html += `<div class="dynamic-card">
        <div class="dc-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <h4>${esc(s.name || s.id || `Server ${i+1}`)}</h4>
          <span class="dc-meta">${esc(transport)} ${s.enabled === false ? '(disabled)' : ''}</span>
        </div>
        <div class="dc-body">
          <div class="form-row">
            <div class="form-group"><label>ID</label><input type="text" data-mcp="${i}" data-field="id" value="${esc(s.id || '')}"></div>
            <div class="form-group"><label>Name</label><input type="text" data-mcp="${i}" data-field="name" value="${esc(s.name || '')}"></div>
          </div>
          <div class="toggle-wrap">
            <div class="toggle"><input type="checkbox" data-mcp="${i}" data-field="enabled" ${s.enabled !== false ? 'checked' : ''}><span class="slider"></span></div>
            <label>Enabled</label>
          </div>
          <div class="form-group"><label>Transport</label>
            <select data-mcp="${i}" data-field="transport">
              <option value="sse" ${transport==='sse'?'selected':''}>SSE</option>
              <option value="websocket" ${transport==='websocket'?'selected':''}>WebSocket</option>
              <option value="http" ${transport==='http'?'selected':''}>HTTP</option>
              <option value="stdio" ${transport==='stdio'?'selected':''}>Stdio</option>
            </select>
          </div>
          <div class="form-group"><label>URL</label><input type="text" data-mcp="${i}" data-field="url" value="${esc(s.url || '')}"></div>
          <div class="form-group"><label>Command (stdio)</label><input type="text" data-mcp="${i}" data-field="command" value="${esc(s.command || '')}"></div>
          <div class="form-group"><label>Args (stdio, comma-separated)</label><input type="text" data-mcp="${i}" data-field="args" value="${esc((s.args||[]).join(', '))}"></div>
          <div class="form-row">
            <div class="form-group"><label>Auth Type</label>
              <select data-mcp="${i}" data-field="auth_type">
                <option value="none" ${(!s.auth_type||s.auth_type==='none')?'selected':''}>None</option>
                <option value="token" ${s.auth_type==='token'?'selected':''}>Token</option>
                <option value="basic" ${s.auth_type==='basic'?'selected':''}>Basic</option>
              </select>
            </div>
            <div class="form-group"><label>Auth Token</label><input type="password" data-mcp="${i}" data-field="auth_token" value="${s.auth_token ? '***' : ''}"></div>
          </div>
          <div class="form-row-3">
            <div class="form-group"><label>Timeout (s)</label><input type="number" data-mcp="${i}" data-field="timeout" value="${s.timeout || ''}"></div>
            <div class="form-group"><label>Retry Max</label><input type="number" data-mcp="${i}" data-field="retry_max_attempts" value="${s.retry_max_attempts || ''}"></div>
            <div class="form-group"><label>Retry Backoff</label><input type="number" data-mcp="${i}" data-field="retry_backoff" value="${s.retry_backoff || ''}" step="0.1"></div>
          </div>
          <div style="margin-top:0.5rem">
            <button class="btn btn-danger btn-sm" onclick="Panels.mcpRemove(${i})">Delete Server</button>
          </div>
        </div>
      </div>`;
    });
    el.innerHTML = html;
  },

  mcpAdd() {
    this._mcpServers.push({ id: '', name: 'New Server', enabled: true, transport: 'sse', url: '' });
    this._renderMCPList();
    // Open the last card
    const cards = $$('#mcp-list .dynamic-card .dc-body');
    if (cards.length) cards[cards.length - 1].classList.add('open');
  },

  mcpRemove(i) {
    if (!confirm('Delete this MCP server?')) return;
    this._mcpServers.splice(i, 1);
    this._renderMCPList();
  },

  _collectMCP() {
    const servers = [];
    const inputs = $$('[data-mcp]');
    const byIdx = {};
    inputs.forEach(el => {
      const i = el.dataset.mcp;
      if (!byIdx[i]) byIdx[i] = {};
      const f = el.dataset.field;
      if (el.type === 'checkbox') byIdx[i][f] = el.checked;
      else byIdx[i][f] = el.value;
    });
    for (const idx of Object.keys(byIdx).sort((a,b)=>a-b)) {
      const d = byIdx[idx];
      const srv = {
        id: d.id || '',
        name: d.name || '',
        enabled: d.enabled !== false,
        transport: d.transport || 'sse',
        url: d.url || '',
      };
      if (d.command) srv.command = d.command;
      if (d.args) srv.args = d.args.split(',').map(s=>s.trim()).filter(Boolean);
      if (d.auth_type && d.auth_type !== 'none') srv.auth_type = d.auth_type;
      if (d.auth_token && d.auth_token !== '***') srv.auth_token = d.auth_token;
      if (d.timeout) srv.timeout = parseInt(d.timeout);
      if (d.retry_max_attempts) srv.retry_max_attempts = parseInt(d.retry_max_attempts);
      if (d.retry_backoff) srv.retry_backoff = parseFloat(d.retry_backoff);
      servers.push(srv);
    }
    return servers;
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Crawl4AI
  // ----------------------------------------------------------
  build_crawl4ai() {
    this._mkPanel('crawl4ai', 'Crawl4AI', `
      <div class="card" data-section="integrations">
        ${FB.toggle('crawl4ai_enabled', 'Enabled')}
        ${FB.text('crawl4ai_api_url', 'API URL', { storage: 'config', placeholder: 'http://localhost:11235' })}
        ${FB.password('crawl4ai_api_token', 'API Token')}
        ${FB.text('crawl4ai_collection', 'Collection', { storage: 'config' })}
      </div>
      ${FB.actionBar({ test: "Panels.testCrawl4ai()", panelId: 'crawl4ai', save: "SaveManager.saveCrawl4ai()" })}
    `, 'crawl4ai');
  },

  async load_crawl4ai() {
    const cfg = await this._loadLive();
    const c = cfg.integrations?.crawl4ai || {};
    this._setChecked('crawl4ai_enabled', c.enabled || false);
    this._setVal('crawl4ai_api_url', c.api_url || '');
    this._setVal('crawl4ai_api_token', c.api_token ? '***' : '');
    this._setVal('crawl4ai_collection', c.collection || '');
  },

  async testCrawl4ai() {
    const el = $('#test-crawl4ai');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = {
        api_url: this._getVal('crawl4ai_api_url'),
        api_token: this._getVal('crawl4ai_api_token'),
      };
      const r = await api('/admin/api/test/crawl4ai', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // CONNECTIONS: Filesystem
  // ----------------------------------------------------------
  build_filesystem() {
    this._mkPanel('filesystem', 'Filesystem', `
      <div class="card" data-section="integrations">
        ${FB.text('fs_root_dir', 'Root Directory', { storage: 'config', placeholder: '/home/user/documents' })}
        ${FB.toggle('fs_allow_write', 'Allow Write')}
        ${FB.toggle('fs_allow_delete', 'Allow Delete')}
      </div>
      ${FB.actionBar({ panelId: 'filesystem', save: "SaveManager.saveFilesystem()" })}
    `);
  },

  async load_filesystem() {
    const cfg = await this._loadLive();
    const f = cfg.integrations?.filesystem || {};
    this._setVal('fs_root_dir', f.root_dir || '');
    this._setChecked('fs_allow_write', f.allow_write || false);
    this._setChecked('fs_allow_delete', f.allow_delete || false);
  },

  // ----------------------------------------------------------
  // INFRASTRUCTURE: PostgreSQL
  // ----------------------------------------------------------
  build_postgresql() {
    this._mkPanel('postgresql', 'PostgreSQL', `
      ${FB.note('Database settings are bootstrap config and cannot be changed here. Showing read-only values from the running configuration.')}
      <div class="card">
        <div class="form-row">
          ${FB.text('pg_host', 'Host', { readonly: true, storage: 'config' })}
          ${FB.text('pg_port', 'Port', { readonly: true, storage: 'config' })}
        </div>
        <div class="form-row">
          ${FB.text('pg_user', 'User', { readonly: true, storage: 'config' })}
          ${FB.text('pg_password', 'Password', { readonly: true, storage: 'config' })}
        </div>
        ${FB.text('pg_db_name', 'Database', { readonly: true, storage: 'config' })}
      </div>
    `, 'postgresql');
  },

  async load_postgresql() {
    const cfg = await this._loadLive();
    const d = cfg.database || {};
    this._setVal('pg_host', d.host || '');
    this._setVal('pg_port', d.port || '');
    this._setVal('pg_user', d.user || '');
    this._setVal('pg_password', d.password || '***');
    this._setVal('pg_db_name', d.db_name || '');
  },

  // ----------------------------------------------------------
  // INFRASTRUCTURE: Qdrant
  // ----------------------------------------------------------
  build_qdrant() {
    this._mkPanel('qdrant', 'Qdrant Vector DB', `
      <div class="card" data-section="vector_db">
        ${FB.text('qdrant_url', 'URL', { storage: 'config', placeholder: 'http://localhost:6333' })}
        ${FB.password('qdrant_api_key', 'API Key')}
        <div class="form-row">
          ${FB.text('qdrant_host', 'Host (alternative)', { storage: 'config' })}
          ${FB.number('qdrant_port', 'Port', { storage: 'config' })}
        </div>
        ${FB.text('qdrant_collection', 'Collection', { storage: 'config' })}
      </div>
      ${FB.actionBar({ test: "Panels.testQdrant()", panelId: 'qdrant', save: "SaveManager.saveQdrant()" })}
    `, 'qdrant');
  },

  async load_qdrant() {
    const cfg = await this._loadLive();
    const v = cfg.vector_db || {};
    this._setVal('qdrant_url', v.url || '');
    this._setVal('qdrant_api_key', v.api_key ? '***' : '');
    this._setVal('qdrant_host', v.host || '');
    this._setVal('qdrant_port', v.port || '');
    this._setVal('qdrant_collection', v.collection || '');
  },

  async testQdrant() {
    const el = $('#test-qdrant');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = {
        url: this._getVal('qdrant_url'),
        api_key: this._getVal('qdrant_api_key'),
        host: this._getVal('qdrant_host'),
        port: this._getVal('qdrant_port'),
      };
      const r = await api('/admin/api/test/qdrant', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // INFRASTRUCTURE: Redis
  // ----------------------------------------------------------
  build_redis() {
    this._mkPanel('redis', 'Redis Cache', `
      <div class="card" data-section="cache">
        ${FB.toggle('cache_enabled', 'Enabled')}
        ${FB.number('cache_ttl', 'TTL (seconds)', { storage: 'config' })}
        ${FB.number('cache_max_size', 'Max Size', { storage: 'config' })}
        ${FB.toggle('cache_selective', 'Selective Caching')}
        ${FB.number('cache_min_tokens', 'Min Tokens', { storage: 'config' })}
        ${FB.text('cache_redis_url', 'Redis URL', { storage: 'config', placeholder: 'redis://localhost:6379/0' })}
      </div>
      ${FB.actionBar({ test: "Panels.testRedis()", panelId: 'redis', save: "SaveManager.saveRedis()" })}
    `, 'redis');
  },

  async load_redis() {
    const cfg = await this._loadLive();
    const c = cfg.cache || {};
    this._setChecked('cache_enabled', c.enabled || false);
    this._setVal('cache_ttl', c.ttl || '');
    this._setVal('cache_max_size', c.max_size || '');
    this._setChecked('cache_selective', c.selective || false);
    this._setVal('cache_min_tokens', c.min_tokens || '');
    this._setVal('cache_redis_url', c.redis_url || '');
  },

  async testRedis() {
    const el = $('#test-redis');
    el.innerHTML = '<span class="spinner"></span>';
    try {
      const body = { redis_url: this._getVal('cache_redis_url') };
      const r = await api('/admin/api/test/redis', { method: 'POST', body: JSON.stringify(body) });
      el.className = 'test-result ' + r.status;
      el.textContent = r.message;
    } catch(e) { el.className = 'test-result error'; el.textContent = e.message; }
  },

  // ----------------------------------------------------------
  // MEDIA: TTS
  // ----------------------------------------------------------
  build_tts() {
    this._mkPanel('tts', 'Text-to-Speech', `
      <div class="card" data-section="tts">
        ${FB.toggle('tts_enabled', 'Enabled')}
        ${FB.text('tts_voice_name', 'Voice Name', { storage: 'config', datalist: 'dl-voices' })}
        ${FB.text('tts_language_code', 'Language Code', { storage: 'config', placeholder: 'en-US' })}
        ${FB.slider('tts_speaking_rate', 'Speaking Rate', 0.25, 4.0, 0.05)}
        ${FB.slider('tts_pitch', 'Pitch', -20, 20, 0.5)}
        ${FB.toggle('tts_auto_play', 'Auto-Play')}
      </div>
      ${FB.actionBar({ panelId: 'tts', save: "SaveManager.saveSection('tts','tts')" })}
    `);
  },

  async load_tts() {
    const cfg = await this._loadLive();
    const t = cfg.tts || {};
    this._setChecked('tts_enabled', t.enabled || false);
    this._setVal('tts_voice_name', t.voice_name || '');
    this._setVal('tts_language_code', t.language_code || 'en-US');
    this._setRange('tts_speaking_rate', t.speaking_rate ?? 1.0);
    this._setRange('tts_pitch', t.pitch ?? 0);
    this._setChecked('tts_auto_play', t.auto_play || false);
  },

  // ----------------------------------------------------------
  // MEDIA: STT
  // ----------------------------------------------------------
  build_stt() {
    this._mkPanel('stt', 'Speech-to-Text', `
      <div class="card" data-section="stt">
        ${FB.toggle('stt_enabled', 'Enabled')}
        ${FB.text('stt_language_code', 'Language Code', { storage: 'config', placeholder: 'en-US' })}
        ${FB.dropdown('stt_model', 'Model', [
          { value: 'latest_long', label: 'Latest Long' },
          { value: 'latest_short', label: 'Latest Short' },
          { value: 'command_and_search', label: 'Command & Search' },
          { value: 'phone_call', label: 'Phone Call' },
        ])}
        ${FB.toggle('stt_auto_punctuation', 'Auto Punctuation')}
      </div>
      ${FB.actionBar({ panelId: 'stt', save: "SaveManager.saveSection('stt','stt')" })}
    `);
  },

  async load_stt() {
    const cfg = await this._loadLive();
    const s = cfg.stt || {};
    this._setChecked('stt_enabled', s.enabled || false);
    this._setVal('stt_language_code', s.language_code || 'en-US');
    this._setVal('stt_model', s.model || 'latest_long');
    this._setChecked('stt_auto_punctuation', s.enable_automatic_punctuation !== false);
  },

  // ----------------------------------------------------------
  // AUTOMATION: Scheduler
  // ----------------------------------------------------------
  build_scheduler() {
    this._mkPanel('scheduler', 'Scheduler', `
      <div class="card" data-section="scheduler">
        ${FB.toggle('sched_enabled', 'Enabled')}
        ${FB.text('sched_timezone', 'Timezone', { storage: 'config', datalist: 'dl-timezones' })}
        ${FB.number('sched_max_concurrent', 'Max Concurrent Jobs', { storage: 'config' })}
      </div>
      ${FB.actionBar({ panelId: 'scheduler', save: "SaveManager.saveSection('scheduler','scheduler')" })}
    `);
  },

  async load_scheduler() {
    const cfg = await this._loadLive();
    const s = cfg.scheduler || {};
    this._setChecked('sched_enabled', s.enabled || false);
    this._setVal('sched_timezone', s.timezone || '');
    this._setVal('sched_max_concurrent', s.max_concurrent_jobs || '');
  },

  // ----------------------------------------------------------
  // AUTOMATION: Webhooks
  // ----------------------------------------------------------
  build_webhooks() {
    this._mkPanel('webhooks', 'Webhooks', `
      <div class="card" data-section="webhooks">
        ${FB.toggle('webhooks_enabled', 'Enabled')}
        ${FB.note('Webhook definitions are managed through the chat interface using the webhook tools.')}
      </div>
      ${FB.actionBar({ panelId: 'webhooks', save: "SaveManager.saveSection('webhooks','webhooks')" })}
    `);
  },

  async load_webhooks() {
    const cfg = await this._loadLive();
    const w = cfg.webhooks || {};
    this._setChecked('webhooks_enabled', w.enabled || false);
  },

  // ----------------------------------------------------------
  // ADVANCED: Credentials
  // ----------------------------------------------------------
  build_credentials() {
    this._mkPanel('credentials', 'Credentials Store', `
      <div class="card">
        <h3>Store Credential</h3>
        <div class="form-row">
          <div class="form-group"><label>Name</label><input type="text" id="cred-new-name" placeholder="e.g. google_api_key"></div>
          <div class="form-group"><label>Type</label>
            <select id="cred-new-type">
              <option value="api_key">API Key</option>
              <option value="oauth_token">OAuth Token</option>
              <option value="service_account">Service Account JSON</option>
              <option value="oauth_client">OAuth Client JSON</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Description</label><input type="text" id="cred-new-desc" placeholder="What is this credential for?"></div>
        <div class="form-group"><label>Value</label><textarea id="cred-new-value" placeholder="Paste credential value"></textarea></div>
        <button class="btn btn-primary" onclick="Panels.credStore()">Store Credential</button>
      </div>
      <div class="card">
        <h3>Stored Credentials</h3>
        <div id="cred-table"></div>
      </div>
    `);
  },

  async load_credentials() {
    try {
      const data = await api('/admin/api/credentials');
      const el = $('#cred-table');
      const creds = data.filter(c => c.credential_type !== 'internal' && c.credential_type !== 'config');
      if (!creds.length) { el.innerHTML = '<p class="empty">No credentials in the encrypted store. API keys in config.yaml are not shown here.</p>'; return; }
      let html = '<table><thead><tr><th>Name</th><th>Type</th><th>Description</th><th>Updated</th><th></th></tr></thead><tbody>';
      for (const c of creds) {
        const updated = c.updated_at ? new Date(c.updated_at).toLocaleString() : '-';
        html += `<tr><td>${esc(c.name)}</td><td>${esc(c.credential_type)}</td><td>${esc(c.description||'')}</td><td>${updated}</td>
          <td><button class="btn btn-danger btn-sm" onclick="Panels.credDelete('${esc(c.name)}')">Delete</button></td></tr>`;
      }
      html += '</tbody></table>';
      el.innerHTML = html;
    } catch(e) { $('#cred-table').innerHTML = `<p class="empty">Error: ${esc(e.message)}</p>`; }
  },

  async credStore() {
    const name = $('#cred-new-name').value.trim();
    const value = $('#cred-new-value').value;
    const credential_type = $('#cred-new-type').value;
    const description = $('#cred-new-desc').value.trim() || undefined;
    if (!name || !value) { toast('Name and value required', 'error'); return; }
    try {
      await api('/admin/api/credentials', {
        method: 'POST',
        body: JSON.stringify({ name, value, credential_type, description })
      });
      toast('Credential stored', 'success');
      $('#cred-new-name').value = '';
      $('#cred-new-value').value = '';
      $('#cred-new-desc').value = '';
      this.load_credentials();
    } catch(e) { toast(e.message, 'error'); }
  },

  async credDelete(name) {
    if (!confirm(`Delete credential "${name}"?`)) return;
    try {
      await api(`/admin/api/credentials/${encodeURIComponent(name)}`, { method: 'DELETE' });
      toast('Deleted', 'success');
      this.load_credentials();
    } catch(e) { toast(e.message, 'error'); }
  },

  // ----------------------------------------------------------
  // ADVANCED: Raw Config
  // ----------------------------------------------------------
  build_raw_config() {
    this._mkPanel('raw-config', 'Raw Configuration', `
      <div class="card">
        <h3>Edit Config Section</h3>
        <div class="form-row">
          <div class="form-group"><label>Section</label>
            <select id="raw-section" onchange="$('#raw-custom-wrap').style.display=this.value==='_custom'?'block':'none'">
              <option value="api_keys">api_keys</option>
              <option value="agent">agent</option>
              <option value="integrations">integrations</option>
              <option value="cache">cache</option>
              <option value="vector_db">vector_db</option>
              <option value="tts">tts</option>
              <option value="stt">stt</option>
              <option value="web">web</option>
              <option value="logging">logging</option>
              <option value="scheduler">scheduler</option>
              <option value="webhooks">webhooks</option>
              <option value="_custom">Custom...</option>
            </select>
          </div>
          <div class="form-group" id="raw-custom-wrap" style="display:none"><label>Custom Name</label><input type="text" id="raw-custom-name"></div>
        </div>
        <div class="form-group"><label>JSON Value</label><textarea id="raw-json" class="large" placeholder='{"key":"value"}'></textarea></div>
        <div style="display:flex;gap:0.5rem">
          <button class="btn btn-primary" onclick="Panels.rawSave()">Save Section</button>
          <button class="btn btn-secondary" onclick="Panels.rawLoad()">Load Current</button>
        </div>
      </div>
      <div class="card">
        <h3>Stored Config Sections</h3>
        <div id="raw-sections"></div>
      </div>
      <div class="card">
        <h3>Live Merged Config</h3>
        <button class="btn btn-secondary btn-sm" onclick="Panels.rawLoadLive()" style="margin-bottom:0.8rem">Refresh</button>
        <pre id="raw-live">Click Refresh to load...</pre>
      </div>
    `);
  },

  async load_raw_config() {
    // Load stored sections
    try {
      const data = await api('/admin/api/config');
      const el = $('#raw-sections');
      const sections = Object.keys(data).sort();
      if (!sections.length) { el.innerHTML = '<p class="empty">No config sections stored in DB.</p>'; return; }
      let html = '';
      for (const s of sections) {
        html += `<div class="dynamic-card">
          <div class="dc-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <h4>${esc(s)}</h4>
            <div>
              <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();Panels.rawEdit('${esc(s)}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();Panels.rawDelete('${esc(s)}')">Delete</button>
            </div>
          </div>
          <div class="dc-body"><pre>${esc(JSON.stringify(data[s], null, 2))}</pre></div>
        </div>`;
      }
      el.innerHTML = html;
    } catch(e) { $('#raw-sections').innerHTML = `<p class="empty">Error: ${esc(e.message)}</p>`; }
  },

  _getRawSection() {
    const sel = $('#raw-section').value;
    if (sel === '_custom') return ($('#raw-custom-name').value || '').trim();
    return sel;
  },

  async rawLoad() {
    const section = this._getRawSection();
    if (!section) { toast('Select a section', 'error'); return; }
    try {
      let data;
      try {
        data = await api(`/admin/api/config/${encodeURIComponent(section)}`);
      } catch {
        const live = await api('/admin/api/config-live');
        data = live[section] || {};
      }
      $('#raw-json').value = JSON.stringify(data, null, 2);
    } catch(e) { toast(e.message, 'error'); }
  },

  async rawSave() {
    const section = this._getRawSection();
    if (!section) { toast('Select a section', 'error'); return; }
    let parsed;
    try { parsed = JSON.parse($('#raw-json').value); } catch(e) { toast('Invalid JSON: ' + e.message, 'error'); return; }
    try {
      await api(`/admin/api/config/${encodeURIComponent(section)}`, { method: 'PUT', body: JSON.stringify(parsed) });
      toast(`Config "${section}" saved & hot-reloaded`, 'success');
      this.load_raw_config();
    } catch(e) { toast(e.message, 'error'); }
  },

  async rawEdit(section) {
    try {
      const data = await api(`/admin/api/config/${encodeURIComponent(section)}`);
      const sel = $('#raw-section');
      const opt = Array.from(sel.options).find(o => o.value === section);
      if (opt) { sel.value = section; $('#raw-custom-wrap').style.display = 'none'; }
      else { sel.value = '_custom'; $('#raw-custom-wrap').style.display = 'block'; $('#raw-custom-name').value = section; }
      $('#raw-json').value = JSON.stringify(data, null, 2);
      $('#panel-raw-config').scrollTo({ top: 0, behavior: 'smooth' });
    } catch(e) { toast(e.message, 'error'); }
  },

  async rawDelete(section) {
    if (!confirm(`Delete config section "${section}"? This reverts to file/default.`)) return;
    try {
      await api(`/admin/api/config/${encodeURIComponent(section)}`, { method: 'DELETE' });
      toast('Deleted', 'success');
      this.load_raw_config();
    } catch(e) { toast(e.message, 'error'); }
  },

  async rawLoadLive() {
    try {
      const data = await api('/admin/api/config-live');
      $('#raw-live').textContent = JSON.stringify(data, null, 2);
    } catch(e) { $('#raw-live').textContent = 'Error loading config'; }
  },

  // ----------------------------------------------------------
  // Helpers
  // ----------------------------------------------------------
  _liveCache: null,
  _liveCacheTime: 0,

  async _loadLive() {
    // Cache for 5 seconds
    if (this._liveCache && Date.now() - this._liveCacheTime < 5000) return this._liveCache;
    try {
      this._liveCache = await api('/admin/api/config-live');
      this._liveCacheTime = Date.now();
      return this._liveCache;
    } catch(e) {
      console.error('Failed to load live config:', e);
      toast('Failed to load config: ' + e.message, 'error');
      return {};
    }
  },

  _invalidateLiveCache() {
    this._liveCache = null;
    this._liveCacheTime = 0;
  },

  _activePanel() {
    return $('.panel.active') || document;
  },

  _setVal(name, val) {
    const el = this._activePanel().querySelector(`[name="${name}"]`);
    if (el) el.value = val ?? '';
  },

  _getVal(name) {
    const el = this._activePanel().querySelector(`[name="${name}"]`);
    return el ? el.value : '';
  },

  _setChecked(name, val) {
    const el = this._activePanel().querySelector(`input[name="${name}"]`);
    if (el) el.checked = !!val;
  },

  _getChecked(name) {
    const el = this._activePanel().querySelector(`input[name="${name}"]`);
    return el ? el.checked : false;
  },

  _setRange(name, val) {
    const el = this._activePanel().querySelector(`input[name="${name}"]`);
    if (el) {
      el.value = val;
      const span = el.nextElementSibling;
      if (span) span.textContent = val;
    }
  },

  _updateConditionals() {
    const panel = this._activePanel();
    panel.querySelectorAll('.conditional').forEach(el => {
      const cond = el.dataset.cond;
      if (!cond) return;
      if (cond.includes(':')) {
        // dropdown value condition
        const [name, val] = cond.split(':');
        const input = panel.querySelector(`[name="${name}"]`);
        el.classList.toggle('visible', input && input.value === val);
      } else {
        // toggle condition
        const input = panel.querySelector(`input[name="${cond}"]`);
        el.classList.toggle('visible', input && input.checked);
      }
    });
  },
};

// =====================================================================
// SaveManager
// =====================================================================
const SaveManager = {
  async saveGoogle() {
    try {
      // Save API key credential if changed
      const apiKey = Panels._getVal('google_api_key');
      if (apiKey && apiKey !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'google_api_key', value: apiKey, credential_type: 'api_key', description: 'Google API Key' })
        });
      }
      // Save service account if provided
      const sa = Panels._getVal('google_service_account');
      if (sa && sa !== '***' && sa.trim()) {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'google_service_account', value: sa, credential_type: 'service_account', description: 'Google Service Account' })
        });
      }
      // Save agent config (vertex settings)
      const agentPatch = {
        use_vertex_ai: Panels._getChecked('use_vertex_ai'),
        vertex_project: Panels._getVal('vertex_project'),
        vertex_location: Panels._getVal('vertex_location'),
      };
      await this._mergeSection('agent', agentPatch);
      toast('Google API settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveSection(panelId, section) {
    try {
      const panel = $(`#panel-${panelId}`);
      const obj = this._collectFields(panel, section);
      await this._mergeSection(section, obj);
      toast(`${section} settings saved`, 'success');
      Panels._invalidateLiveCache();
    } catch(e) { toast(e.message, 'error'); }
  },

  _collectFields(panel, section) {
    const obj = {};
    if (!panel) return obj;
    panel.querySelectorAll('[name][data-storage="config"]').forEach(el => {
      let val;
      if (el.type === 'checkbox') val = el.checked;
      else if (el.type === 'number' || el.type === 'range') val = el.value ? parseFloat(el.value) : undefined;
      else val = el.value;
      if (val === undefined || val === '') return;
      // Handle dotted names like "agent_models.search"
      const name = el.getAttribute('name');
      const parts = name.split('.');
      if (parts.length === 1) obj[name] = val;
      else {
        let target = obj;
        for (let i = 0; i < parts.length - 1; i++) {
          if (!target[parts[i]]) target[parts[i]] = {};
          target = target[parts[i]];
        }
        target[parts[parts.length - 1]] = val;
      }
    });
    return obj;
  },

  async _mergeSection(section, patch) {
    // Load current, merge, save
    let current = {};
    try {
      current = await api(`/admin/api/config/${encodeURIComponent(section)}`);
    } catch {
      // Not in DB yet, try live config
      try {
        const live = await api('/admin/api/config-live');
        current = live[section] || {};
      } catch { /* start fresh */ }
    }
    const merged = this._deepMerge(current, patch);
    await api(`/admin/api/config/${encodeURIComponent(section)}`, {
      method: 'PUT',
      body: JSON.stringify(merged)
    });
  },

  _deepMerge(target, source) {
    const result = { ...target };
    for (const [k, v] of Object.entries(source)) {
      if (v && typeof v === 'object' && !Array.isArray(v) && typeof result[k] === 'object' && !Array.isArray(result[k])) {
        result[k] = this._deepMerge(result[k], v);
      } else {
        result[k] = v;
      }
    }
    return result;
  },

  async saveGmail() {
    try {
      const oauthClient = Panels._getVal('gmail_oauth_client');
      if (oauthClient && oauthClient.trim() && oauthClient !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'gmail_oauth_client', value: oauthClient, credential_type: 'oauth_client', description: 'Gmail OAuth Client JSON' })
        });
      }
      await this._mergeSection('integrations', {
        gmail: { enabled: Panels._getChecked('gmail_enabled') }
      });
      toast('Gmail settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveCalendar() {
    try {
      const sa = Panels._getVal('calendar_service_account');
      if (sa && sa.trim() && sa !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'calendar_service_account', value: sa, credential_type: 'service_account', description: 'Calendar Service Account' })
        });
      }
      await this._mergeSection('integrations', {
        calendar: {
          enabled: Panels._getChecked('calendar_enabled'),
          calendar_id: Panels._getVal('calendar_id'),
          timezone: Panels._getVal('calendar_timezone'),
          impersonation_email: Panels._getVal('calendar_impersonation_email'),
        }
      });
      toast('Calendar settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveJira() {
    try {
      const token = Panels._getVal('jira_api_token');
      if (token && token !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'jira_api_token', value: token, credential_type: 'api_key', description: 'Jira API Token' })
        });
      }
      await this._mergeSection('integrations', {
        jira: {
          enabled: Panels._getChecked('jira_enabled'),
          url: Panels._getVal('jira_url'),
          email: Panels._getVal('jira_email'),
        }
      });
      toast('Jira settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveHA() {
    try {
      const token = Panels._getVal('ha_token');
      if (token && token !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'ha_token', value: token, credential_type: 'api_key', description: 'Home Assistant Access Token' })
        });
      }
      await this._mergeSection('integrations', {
        home_assistant: {
          enabled: Panels._getChecked('ha_enabled'),
          url: Panels._getVal('ha_url'),
          mcp_sse_url: Panels._getVal('ha_mcp_sse_url'),
        }
      });
      toast('Home Assistant settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveTavily() {
    try {
      const key = Panels._getVal('tavily_api_key');
      if (key && key !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'tavily_api_key', value: key, credential_type: 'api_key', description: 'Tavily API Key' })
        });
      }
      toast('Tavily settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveMCP() {
    try {
      const servers = Panels._collectMCP();
      // Save auth tokens as credentials
      for (const s of servers) {
        if (s.auth_token && s.auth_token !== '***' && s.id) {
          await api('/admin/api/credentials', {
            method: 'POST',
            body: JSON.stringify({ name: `mcp_${s.id}_auth_token`, value: s.auth_token, credential_type: 'api_key', description: `MCP ${s.name || s.id} auth token` })
          });
          delete s.auth_token; // Don't store in config
        }
      }
      await this._mergeSection('integrations', { mcp: { servers } });
      toast('MCP servers saved', 'success');
      Panels._invalidateLiveCache();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveCrawl4ai() {
    try {
      const token = Panels._getVal('crawl4ai_api_token');
      if (token && token !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'crawl4ai_api_token', value: token, credential_type: 'api_key', description: 'Crawl4AI API Token' })
        });
      }
      await this._mergeSection('integrations', {
        crawl4ai: {
          enabled: Panels._getChecked('crawl4ai_enabled'),
          api_url: Panels._getVal('crawl4ai_api_url'),
          collection: Panels._getVal('crawl4ai_collection'),
        }
      });
      toast('Crawl4AI settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveFilesystem() {
    try {
      await this._mergeSection('integrations', {
        filesystem: {
          root_dir: Panels._getVal('fs_root_dir'),
          allow_write: Panels._getChecked('fs_allow_write'),
          allow_delete: Panels._getChecked('fs_allow_delete'),
        }
      });
      toast('Filesystem settings saved', 'success');
      Panels._invalidateLiveCache();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveQdrant() {
    try {
      const key = Panels._getVal('qdrant_api_key');
      if (key && key !== '***') {
        await api('/admin/api/credentials', {
          method: 'POST',
          body: JSON.stringify({ name: 'qdrant_api_key', value: key, credential_type: 'api_key', description: 'Qdrant API Key' })
        });
      }
      const obj = {
        url: Panels._getVal('qdrant_url'),
        host: Panels._getVal('qdrant_host'),
        collection: Panels._getVal('qdrant_collection'),
      };
      const port = Panels._getVal('qdrant_port');
      if (port) obj.port = parseInt(port);
      await api(`/admin/api/config/vector_db`, {
        method: 'PUT',
        body: JSON.stringify(obj),
      });
      toast('Qdrant settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },

  async saveRedis() {
    try {
      const obj = {
        enabled: Panels._getChecked('cache_enabled'),
        selective: Panels._getChecked('cache_selective'),
        redis_url: Panels._getVal('cache_redis_url'),
      };
      const ttl = Panels._getVal('cache_ttl');
      if (ttl) obj.ttl = parseInt(ttl);
      const maxSize = Panels._getVal('cache_max_size');
      if (maxSize) obj.max_size = parseInt(maxSize);
      const minTokens = Panels._getVal('cache_min_tokens');
      if (minTokens) obj.min_tokens = parseInt(minTokens);

      await this._mergeSection('cache', obj);
      toast('Cache settings saved', 'success');
      Panels._invalidateLiveCache();
      StatusPoller.poll();
    } catch(e) { toast(e.message, 'error'); }
  },
};

// =====================================================================
// Status Poller
// =====================================================================
const StatusPoller = {
  async poll() {
    try {
      const data = await api('/admin/api/status');
      for (const [key, info] of Object.entries(data)) {
        if (key === '_credential_store') {
          const banner = $('#store-banner');
          if (banner) banner.style.display = info.status === 'ok' ? 'none' : 'block';
          continue;
        }
        Sidebar.setDot(key, info.status);
        // Update badge if visible
        const badge = $(`#badge-${key}`);
        if (badge) {
          badge.className = 'badge ' + info.status;
          badge.textContent = info.status === 'ok' ? 'Connected' : info.status === 'error' ? 'Error' : 'Not Configured';
        }
      }
    } catch(e) {
      // Status endpoint not critical
    }
  }
};

// =====================================================================
// App init
// =====================================================================
const App = {
  auth() {
    const token = $('#auth-token').value.trim();
    if (!token) { toast('Enter a token', 'error'); return; }
    Auth.login(token);
  },
  logout() { Auth.logout(); }
};

// Make things globally accessible for onclick handlers
window.App = App;
window.Router = Router;
window.Panels = Panels;
window.SaveManager = SaveManager;
window.StatusPoller = StatusPoller;
Object.defineProperty(window, '_token', { get: () => _token, configurable: true });
window.$ = $;

// Enter key on auth input
document.addEventListener('DOMContentLoaded', () => {
  $('#auth-token').addEventListener('keydown', e => { if (e.key === 'Enter') App.auth(); });
  Auth.check();
});

})();
</script>
</body>
</html>
